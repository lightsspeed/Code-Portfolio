name: Secure Deploy to AWS

on:
  push:
    branches: [ main ]
  pull_request:          # Run on PRs too (shift-left!)
  workflow_dispatch:

permissions:
  contents: read
  security-events: write   # Needed for SARIF uploads
  actions: read

jobs:
  security-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # ------------------- Checkout -------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Needed for accurate SBOM

      # ------------------- Setup Node -------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ------------------- Install & Build -------------------
      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      # ------------------- Secrets Scanning (GitGuardian) -------------------
      - name: GitGuardian Scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}   # Add this secret

      # ------------------- SCA - npm audit -------------------
      - name: NPM Audit (SCA)
        run: |
          npm audit --audit-level=high || echo "High vulnerabilities found"
          npm audit --json > npm-audit.json

      # ------------------- SBOM Generation (Syft) -------------------
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          artifact-name: sbom.spdx.json
          format: spdx-json

      # ------------------- Dependency Review (GitHub native) -------------------
      - name: Dependency Review
        uses: actions/dependency-review-action@v4

      # ------------------- Trivy Filesystem Scan (SCA + config) -------------------
      - name: Trivy Vulnerability Scan (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'CRITICAL,HIGH'

      # ------------------- Upload SARIF results -------------------
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif

      # ------------------- Configure AWS -------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # ------------------- Deploy to S3 -------------------
      - name: Deploy to S3
        run: |
          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }} --delete

      # ------------------- CloudFront Invalidation -------------------
      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      # ------------------- Success Message -------------------
      - name: Deployment Complete
        run: |
          echo "ðŸš€ Secure deployment successful!"
          echo "Site: https://${{ secrets.DOMAIN_NAME }}"